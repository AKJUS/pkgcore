#!/usr/bin/env pkgcore-ebuild-helper
# Copyright: 2012 Brian Harring <ferringb@gmail.com>
# License: GPL2/BSD 3 clause

recursive=false
if [[ $1 == "-r" ]]; then
	recursive=true
	shift
fi

check_args 1 -

if [[ -n ${INSDESTTREE} && -z ${INSDESTTREE%${ED}*} ]]; then
	__helper_exit 2 "do not give \${D} nor \${ED} as part of the pathways to doins"
fi

declare -A FILE_MAPPING

install_paths() {
	local mydir=${1:-.}
	shift
	check_command invoke_script dodir "${mydir}" || return 1

	__shopt_push -s extglob
	# strip trailing slashes
	local paths=( "${@%%+(/)}" )
	__shopt_pop

	for x in "${paths[@]}"; do
		mysrc=${x}
		if [[ -L ${x} ]]; then
			if ! ${PKGCORE_DOINS_ALLOW_SYMLINKS}; then
				check_command cp -- "${x}" "${T}" || continue
				mysrc=${T}/${x##*/}
			else
				check_command cp -P -- "${x}" "${ED}${mydir}/${x##*/}"
				continue
			fi
		elif [[ -d ${x} ]]; then
			${recursive} || continue
			__shopt_push -s dotglob nullglob
			install_paths "${mydir}/${x##*/}" "${x}"/*
			__shopt_pop
			continue
		fi
		FILE_MAPPING[${mydir}]+=" ${mysrc}"
	done
}

# create dirs and determine file mapping
install_paths "${INSDESTTREE}" "$@"

# install files using xargs to decrease install calls
for dir in "${!FILE_MAPPING[@]}"; do
	echo "${FILE_MAPPING[${dir}]}" | ${XARGS} install ${INSOPTIONS} -t "${ED}${dir}" --
	assert "install failed"
done
